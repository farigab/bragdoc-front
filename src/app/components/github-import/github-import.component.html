<p-toast />

<div class="integrated-container">

  <div class="import-container">
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">Welcome back!</h1>
      </div>
    </div>

    <!-- PrimeNG Stepper -->
    <p-stepper [(value)]="activeStep" [linear]="true">

      <p-step-list>
        <p-step [value]="1" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-github"></i>
              Connect
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="2" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-folder"></i>
              Repositories
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="3" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-calendar"></i>
              Time Period
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="4" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-sparkles"></i>
              AI Analysis
            </span>
          </ng-template>
        </p-step>
      </p-step-list>

      <p-step-panels>

        <!-- Step 1: Token Input -->
        <p-step-panel [value]="1">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Connect GitHub Account</h2>
              <p class="subtitle">Enter your Personal Access Token to get started</p>

              <div class="form-row">
                <label for="token-input">Personal Access Token</label>
                <input pInputText id="token-input" type="text" [ngModel]="token()" (ngModelChange)="token.set($event)"
                  placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" aria-describedby="token-help" />
                <small id="token-help" class="help-text">
                  Create a token at
                  <a href="https://github.com/settings/tokens/new?scopes=repo,read:user&description=farigab-bragdoc"
                    target="_blank" rel="noopener noreferrer">
                    GitHub Settings
                  </a>
                  with repo scope
                </small>
              </div>

              <div class="step-actions">
                <p-button label="Connect" icon="pi pi-github" (onClick)="saveToken()" [loading]="loading().repos"
                  [disabled]="!token()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <!-- Step 2: Repository Selection -->
        <p-step-panel [value]="2">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <div class="card-header">
                <h2 class="section-title">Select Repositories</h2>
                <div class="repo-actions">
                  <button type="button" class="link-button" (click)="selectAll()">Select All</button>
                  <button type="button" class="link-button" (click)="clearSelection()">Clear</button>
                </div>
              </div>

              <p class="subtitle">
                @if (selectedCount() > 0) {
                {{ selectedCount() }} {{ selectedCount() === 1 ? 'repository' : 'repositories' }} selected
                } @else {
                All repositories will be included
                }
              </p>

              <div class="repo-grid" role="list">
                @for (repo of repositories(); track repo) {
                <div class="repo-card" role="listitem">
                  <label class="repo-checkbox">
                    <input type="checkbox" [checked]="selectedRepos().has(repo)" (change)="toggleSelection(repo)"
                      [attr.aria-label]="'Select ' + repo" />
                    <span class="repo-name">{{ repo }}</span>
                  </label>
                </div>
                }
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="clearToken()" />
                <p-button label="Continue" (onClick)="activateCallback(3)" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <p-step-panel [value]="3">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Import Date Range</h2>
              <p class="subtitle">Select a date range for importing data</p>

              <div class="form-row">
                <label for="date-range">Date Range</label>
                <p-select id="date-range" [options]="presetOptions" [ngModel]="selectedPreset()" optionLabel="label"
                  placeholder="Select a preset" (ngModelChange)="onPresetChange($event)"
                  aria-describedby="date-range-help">
                </p-select>

                @if (selectedPreset() === 'custom') {
                <div class="custom-date-range">
                  <p-datepicker [(ngModel)]="customStart" [showIcon]="true" placeholder="Start date"></p-datepicker>
                  <p-datepicker [(ngModel)]="customEnd" [showIcon]="true" placeholder="End date"></p-datepicker>
                </div>
                }

                <small id="date-range-help" class="help-text">
                  Choose a preset or select a custom range
                </small>
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="activateCallback(2)" />
                <p-button label="Continue" (onClick)="activateCallback(4)" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>


        <!-- Step 4: AI Prompt & Analysis -->
        <p-step-panel [value]="4">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Análise com IA</h2>
              <p class="subtitle">Personalize o prompt para a análise automática</p>

              <div class="form-row">
                <label for="ai-prompt">Prompt para IA</label>
                <textarea pInputTextarea id="ai-prompt" rows="6" [ngModel]="customPrompt()"
                  (ngModelChange)="customPrompt.set($event)" placeholder="Escreva o prompt para a IA..."
                  aria-describedby="ai-prompt-help"></textarea>
                <small id="ai-prompt-help" class="help-text">Use instruções claras e exemplos para melhores
                  resultados</small>
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="activateCallback(3)" />
                <p-button label="Análise IA" icon="pi pi-robot" (onClick)="analyzeAI()" [disabled]="!customPrompt()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

      </p-step-panels>
    </p-stepper>
  </div>

  <!-- Side Panel -->
  <aside class="side-panel">
    <div class="side-card github-card">
      <div class="side-card-header">
        <i class="pi pi-github"></i> GitHub Connected
      </div>
      <div class="side-card-body github-connected">
        @if (user(); as u) {
        <img class="gh-avatar-img" [src]="u.avatarUrl" [alt]="u.login" />
        <div class="gh-info">
          <div class="gh-user">{{ u.login }}</div>
        </div>
        <div class="gh-actions">
          <p-button label="Profile" [text]="true" size="small" />
          <p-button label="Update" [text]="true" size="small" />
        </div>
        } @else {
        <div class="gh-avatar">GH</div>
        <div class="gh-info">
          <div class="gh-user">Not connected</div>
        </div>
        }
      </div>
    </div>
  </aside>

</div>
