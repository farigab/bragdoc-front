<p-toast />

<div class="integrated-container">

  <div class="import-container">
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">Welcome back!</h1>
      </div>
    </div>

    <!-- PrimeNG Stepper -->
    <p-stepper [(value)]="activeStep" [linear]="true">

      <p-step-list>
        <p-step [value]="1" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-github"></i>
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="2" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-folder"></i>
            </span>
          </ng-template>
        </p-step>

        <p-step [value]="3" class="step-header">
          <ng-template #content let-value="value">
            <span class="step-circle" [class.active]="value <= activeStep">
              <i class="pi pi-calendar"></i>
            </span>
          </ng-template>
        </p-step>
      </p-step-list>

      <p-step-panels>

        <!-- Step 1: Token Input -->
        <p-step-panel [value]="1">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Connect GitHub Account</h2>
              <p class="subtitle">Enter your Personal Access Token to get started</p>

              <div class="form-row">
                <label for="token-input">Personal Access Token</label>
                <input pInputText id="token-input" type="text" [ngModel]="token()" (ngModelChange)="token.set($event)"
                  placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" aria-describedby="token-help" />
                <small id="token-help" class="help-text">
                  Create a token at
                  <a href="https://github.com/settings/tokens/new?scopes=repo,read:user&description=farigab-bragdoc"
                    target="_blank" rel="noopener noreferrer">
                    GitHub Settings
                  </a>
                  with repo scope
                </small>
              </div>

              <div class="step-actions">
                <p-button label="Connect" icon="pi pi-github" (onClick)="saveToken()"
                  [loading]="loading().repos" [disabled]="!token()" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <!-- Step 2: Repository Selection -->
        <p-step-panel [value]="2">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <div class="card-header">
                <h2 class="section-title">Select Repositories</h2>
                <div class="repo-actions">
                  <button type="button" class="link-button" (click)="selectAll()">Select All</button>
                  <button type="button" class="link-button" (click)="clearSelection()">Clear</button>
                </div>
              </div>

              <p class="subtitle">
                @if (selectedCount() > 0) {
                {{ selectedCount() }} {{ selectedCount() === 1 ? 'repository' : 'repositories' }} selected
                } @else {
                All repositories will be included
                }
              </p>

              <div class="repo-grid" role="list">
                @for (repo of repositories(); track repo) {
                <div class="repo-card" role="listitem">
                  <label class="repo-checkbox">
                    <input type="checkbox" [checked]="selectedRepos().has(repo)" (change)="toggleSelection(repo)"
                      [attr.aria-label]="'Select ' + repo" />
                    <span class="repo-name">{{ repo }}</span>
                  </label>
                </div>
                }
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true"
                  (onClick)="clearToken()" />
                <p-button label="Continue" (onClick)="activateCallback(3)" />
              </div>
            </div>
          </ng-template>
        </p-step-panel>

        <!-- Step 3: Date Range Selection -->
        <p-step-panel [value]="3">
          <ng-template #content let-activateCallback="activateCallback">
            <div class="step-content">
              <h2 class="section-title">Select Date Range</h2>
              <p class="subtitle">Choose the time period for importing data</p>

              <div class="date-range-container">
                <div class="form-row">
                  <label for="start-date">Start Date</label>
                  <p-datepicker inputId="start-date" [ngModel]="startDate()" (ngModelChange)="startDate.set($event)"
                    dateFormat="yy-mm-dd" [showIcon]="true" placeholder="Select start date"
                    [maxDate]="endDate() ?? maxDate" [iconDisplay]="'input'" />
                </div>

                <div class="form-row">
                  <label for="end-date">End Date</label>
                  <p-datepicker inputId="end-date" [ngModel]="endDate()" (ngModelChange)="endDate.set($event)"
                    dateFormat="yy-mm-dd" [showIcon]="true" placeholder="Select end date" [minDate]="startDate()"
                    [maxDate]="maxDate" [iconDisplay]="'input'" />
                </div>
              </div>

              <div class="summary-section">
                <h3>Import Summary</h3>
                <ul class="summary-list">
                  <li>
                    <strong>Repositories:</strong>
                    @if (selectedCount() > 0) {
                    {{ selectedCount() }} selected
                    } @else {
                    All ({{ repositories().length }})
                    }
                  </li>
                  @if (hasDateRange()) {
                  <li>
                    <strong>Date Range:</strong>
                    {{ startDate()!.toLocaleDateString() }} - {{ endDate()!.toLocaleDateString() }}
                  </li>
                  }
                </ul>
              </div>

              <div class="step-actions">
                <p-button label="Back" severity="secondary" [outlined]="true" (onClick)="activateCallback(2)"
                  [disabled]="isImporting()" />
                <div class="footer-actions">
                  <div class="timer">
                    @if (isImporting()) {
                    Importing data...
                    } @else {
                    ~30 seconds to generate
                    }
                  </div>
                  <p-button label="Start Import" icon="pi pi-download" (onClick)="startImport()"
                    [disabled]="!hasDateRange()" [loading]="isImporting()" />
                </div>
              </div>

              <!-- Success Result -->
              @if (result()) {
              <div class="success-container">
                <i class="pi pi-check-circle success-icon"></i>
                <h2 class="section-title">Import Complete!</h2>
                <p class="subtitle">
                  Your GitHub data has been successfully imported
                </p>

                <div class="result-details">
                  <h3>Import Details</h3>
                  <pre>{{ result() | json }}</pre>
                </div>

                <div class="step-actions">
                  <p-button label="Start Over" severity="secondary" [outlined]="true" (onClick)="startOver()" />
                  <p-button label="View Dashboard" icon="pi pi-chart-line" />
                </div>
              </div>
              }
            </div>
          </ng-template>
        </p-step-panel>

      </p-step-panels>
    </p-stepper>
  </div>

  <!-- Side Panel -->
  <aside class="side-panel">
    <div class="side-card github-card">
      <div class="side-card-header">
        <i class="pi pi-github"></i> GitHub Connected
      </div>
      <div class="side-card-body github-connected">
        @if (user(); as u) {
        <img class="gh-avatar-img" [src]="u.avatarUrl" [alt]="u.login" />
        <div class="gh-info">
          <div class="gh-user">{{ u.login }}</div>
        </div>
        <div class="gh-actions">
          <p-button label="Profile" [text]="true" size="small" />
          <p-button label="Update" [text]="true" size="small" />
        </div>
        } @else {
        <div class="gh-avatar">GH</div>
        <div class="gh-info">
          <div class="gh-user">Not connected</div>
        </div>
        }
      </div>
    </div>
  </aside>

</div>
